# シンプルな修正ガイド（社内専用）

## 🎯 この修正の目的

社内専用のツールなので、セキュリティルールを大幅に簡略化します。

**変更内容：**
- ❌ 「同じ組織のユーザーだけ見られる」という複雑なルール → 削除
- ✅ 「認証されたユーザーは全員、すべてのデータにアクセス可能」というシンプルなルール

## 📋 実行手順

### 1. Supabaseダッシュボードを開く
- https://supabase.com にログイン
- プロジェクトを選択

### 2. SQL Editorを開く
- 左メニューから「SQL Editor」をクリック
- 「New query」をクリック

### 3. 修正SQLを実行
1. `supabase/simple_fix.sql` ファイルを開く
2. **すべての内容をコピー**
3. Supabase SQL Editorに貼り付け
4. **「Run」ボタンをクリック**（または `Cmd/Ctrl + Enter`）

### 4. 成功を確認
- 「Success」メッセージが表示されることを確認
- エラーが表示された場合は、エラーメッセージを確認

### 5. アプリで再試行
1. ブラウザで http://localhost:3002/register を開く
2. 組織名、メールアドレス、パスワードを入力
3. 「登録」ボタンをクリック
4. **エラーなく登録できることを確認**

## ✅ この修正のメリット

### 1. 無限再帰エラーの完全解決
- `users` テーブルを参照する必要がない
- シンプルな `auth.role() = 'authenticated'` チェックのみ
- → 無限再帰が発生しない

### 2. シンプルで理解しやすい
- 複雑な組織ベースのアクセス制御が不要
- 「認証されているか？」だけをチェック
- メンテナンスが容易

### 3. 社内専用に最適
- 社内の人間だけがアクセスする前提
- 外部からのアクセスは認証で防げる
- データの分類（組織）は残すが、アクセス制御には使わない

## 🔒 セキュリティについて

### 現在の設定
- ✅ 認証が必要（メール/パスワード）
- ✅ 認証されたユーザーのみがデータにアクセス可能
- ✅ 組織情報はデータとして保存される（分類用）

### 将来的に外部公開する場合
もし将来的に外部ユーザーにも公開する場合は、組織ベースのアクセス制御を再度追加できます。その際は、無限再帰を避ける設計が必要です。

## 📊 変更内容の詳細

### Before（複雑な設計）
```sql
-- 組織ベースのアクセス制御
CREATE POLICY "Users can view users in their organization"
  ON users FOR SELECT
  USING (
    organization_id = (SELECT organization_id FROM users WHERE id = auth.uid())
    -- ↑ users テーブルを参照 → 無限再帰の原因
  );
```

### After（シンプルな設計）
```sql
-- 認証ベースのアクセス制御
CREATE POLICY "Authenticated users can view all users"
  ON users FOR SELECT
  USING (auth.role() = 'authenticated');
  -- ↑ users テーブルを参照しない → 無限再帰なし
```

## 🎓 まとめ

- **問題**: 複雑な組織ベースのアクセス制御が無限再帰を引き起こしていた
- **解決**: シンプルな認証ベースのアクセス制御に変更
- **結果**: 無限再帰エラーが解消され、社内専用ツールとして適切に動作

この修正により、新規登録が正常に動作するようになります！

